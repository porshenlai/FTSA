<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>FTSA</title>
	<style>
		* { box-sizing: border-box; }
		body, html {
			margin: 0;
			padding: 0;
			height: 100%;
			width: 100%;
			overflow: hidden; 
		}

		body {
			display: flex;
			flex-direction: column;
		}

		header {
			height: 60px;
			background: #2c3e50;
			color: white;
			padding: 0 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-shrink: 0;
		}

		footer {
			height: 30px;
			background: #ecf0f1;
			text-align: center;
			line-height: 30px;
			font-size: 12px;
			flex-shrink: 0;
		}

		main {
			flex-grow: 1;
			display: flex;
			overflow: hidden;
			background: #f9f9f9;
		}

		/* 側邊控制區基礎樣式 */
		aside[UID='Control'] {
			border: 1px solid #ddd;
			padding: 10px;
			overflow-y: auto;
			background: #fff;
			z-index: 10;
		}

		/* 右側/下方 視圖區基礎樣式 */
		section[UID='View'] {
			flex-direction: column;
			background: white;
			border-left: 1px solid #ddd;
			overflow: hidden auto;
		}

		/* 響應式佈局邏輯修正 */
		@media (orientation: landscape) {
			main { flex-direction: row; }
			
			aside[UID='Control'] {
				flex: 1;
				min-width: 30%;
			}
			
			section[UID='View'] {
				flex: 2;
				min-width: 70%;
				max-width: calc(100vh - 90px); /* 限制最大寬度為高度，維持正方形感 */
			}
		}

		@media (orientation: portrait) {
			main { flex-direction: column; }
			
			aside[UID='Control'] {
				flex: 1;
				min-height: 30%;
			}
			
			section[UID='View'] {
				flex: 2;
				min-height: 70%;
				max-height: 100vw;
			}
		}

		section[UID='Chart'] {
			height: 90%;
			border-bottom: 2px solid #eee;
			position: relative;
			background: darkblue;
		}

		section[UID='Table'] {
			min-height: 10%;
			position: relative;
			color: darkgreen; background: white;
			overflow: auto hidden;
		}

		.hidden {
			display: none;
		}

		.hint-btn {
			cursor: pointer;
			text-decoration: underline;
			color: #3498db;
		}
	</style>
	<script src='Data.js'></script>
</head>
<body>

<header>
	<div style='font-size:180%'>Financial Series Token Analyzer</div>
	<div>
		<span UID='User'>Porshen Lai</span>
		(<span class="hint-btn" onclick='document.body.UM.manage()' title="點擊進入帳戶管理">管理</span> | 
		<span class="hint-btn" onclick='document.body.UM.logout()' title="點擊登出系統">登出</span>)
	</div>
</header>

<main>
	<aside UID='Control'>
		<strong>控制面板</strong>
		<hr>
		<p>設定與 TOI 標籤管理區</p>
	</aside>
	<section UID='View'>
		<section UID='Chart'>
		</section>
		<section UID='Table'>
			<div style="text-align:center;">
				目標代號 <select varname="symbol">
					<option value='-'>請選擇</option>
					<option value='2330.TW'>台積電</option>
				</select>，
				從 <input varname="from" type="date"/> 到 <input varname="to" type="date"/>
				<button act="requestData">請求資料</button>
			</div>
			<table class='hidden' border='1' cellspacing='3' cellpadding='1' align='center'>
				<thead><tr>
					<th vn='D'>Date</th>
					<th vn='C'>Close</th>
					<th vn='O'>Open</th>
					<th vn='H'>High</th>
					<th vn='L'>Low</th>
					<th vn='V'>Volume</th>
				</tr></thead>
				<tbody UID='Template'><tr>
					<th vn='D'></th>
					<td vn='C'></td>
					<td vn='O'></td>
					<td vn='H'></td>
					<td vn='L'></td>
					<td vn='V'></td>
				</tr></tbody>
				<tbody UID='List'></tbody>
			</table>
		</section>
	</section>
</main>

<footer>© Cyberpiers/CLUT/Porshen Lai 2026</footer>

<script>
	const Service = {
		worker: null,
		promise: [],
		initWorker: function() {
			this.worker = new SharedWorker('shared_worker.js');
			this.worker.port.onmessage = (e) => {
				const { type, payload } = e.data;
				console.log(`[Worker Message]: ${type}`, payload);
			
				if (type === 'DATA_RESULT') {
					this.promise=this.promise.filter((ps)=>{
						if (ps.sessionKey===payload.key) {
							if (payload.status==="Success")
								ps.onReady(payload.data); 
							else
								ps.onError(payload);
							return false;
						} else
							return true;
					});
				}
				if (type === 'STATUS_UPDATE') {
					this.updateUIStatus(payload);
				}
	  	  	};
	  	  	this.worker.port.start();
		},
		requestData: function(symbol, year) {
			// gemini-helpme: 透過 SharedWorker 索取資料
			let cb={}, ps=new Promise((or,oe)=>{
				cb.sessionKey=(new Date()).getTime().toString(36);
				cb.onReady=or;
				cb.onError=oe;
			});
			Object.assign(ps, cb);
			this.promise.push(ps);
			this.worker.port.postMessage({
				type: 'FETCH_DATA',
				payload: { symbol, year, key:cb.sessionKey }
			});
			return ps;
		},
		updateUIStatus: function(msg) {
			document.querySelector("aside[UID='Control']").innerText = msg;
		}
	};
	Service.initWorker();

	document.body.UM = {
		manage: function() { console.log("User Management - Manage Clicked"); },
		logout: function() { console.log("User Management - Logout Clicked"); }
	};

	document.querySelector('main').DM = {
		// 資料管理物件後續實作
	};

	class StkData extends window.SData {
		async fetch (sid, year) {
			return { "data": await Service.requestData(sid,year) }
		}
	}

	let DB={};

	document.body.addEventListener('click', (evt) => { // {{{
		try {
			let p,e; 
			for(e=evt.target; !e.hasAttribute("act"); e=e.parentNode);
			switch (e.getAttribute('act')) {
			case 'requestData':
				try {
					for (p=e; p.getAttribute("UID")!=="Table"; p=p.parentNode) ;
					e.disabled=true;
					p.querySelector('table').classList.remove("hidden");
					(async (vars) => {
						const sid = vars.symbol;
						if (!DB[sid]) DB[sid]=new StkData(sid);
						let result = await DB[sid].get(vars.from,vars.to);
						if (result) {
							if (result.error) {
								p.querySelector('table').classList.add("hidden");
								e.disabled=false;
							} else {
								console.log("DEBUG:::",result);
								const canvas=p.querySelector('[UID="List"]'),
									temp=p.querySelector('[UID="Template"]');
								while(canvas.firstChild) canvas.removeChild(canvas.firstChild);
								Object.keys(result).forEach(
									(k) => {
										let ne=temp.firstChild.cloneNode(true);
										Array.from(ne.querySelectorAll('[vn]')).forEach(
											(e) => {
												const an=e.getAttribute("vn");
												e.textContent= an==="D" ? k : result[k][an];
											}
										);
										canvas.appendChild(ne);
									}
								);
								e.disabled=false;
							}
						}
					})(
						Array.from(p.querySelectorAll('[varname]')).reduce((r,e) => {
							r[e.getAttribute("varname")]=((e)=>{
								switch(e.getAttribute("type")){
								case "month": return new Date(e.value+"-1");
								case "date": return new Date(e.value);
								default: return e.value;
								}
							})(e);
							return r;
						}, {})
					);
				} catch(x) {
					e.disabled=false;
				}
				break;
			}
		} catch { }
	});	// addEventListener(click) }}}
</script>

</body>
</html>
